<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–∏–≥—Ä–∞—Ü–∏—è —Ñ–æ—Ç–æ ‚Üí ImgBB</title>
  <style>
    body { font-family: monospace; background: #111; color: #eee; padding: 2rem; }
    h2 { color: #38ef7d; }
    button { padding: 0.7rem 1.5rem; font-size: 1rem; background: #38ef7d; color: #222; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; margin-bottom: 1.5rem; }
    button:disabled { background: #555; color: #999; cursor: not-allowed; }
    #log { white-space: pre-wrap; line-height: 1.7; max-height: 70vh; overflow-y: auto; border: 1px solid #333; padding: 1rem; border-radius: 8px; }
    .ok   { color: #38ef7d; }
    .err  { color: #ff6a6a; }
    .info { color: #aaa; }
    #authBlock { margin-bottom: 1.5rem; }
    input[type=email], input[type=password] { padding: 0.5rem 0.8rem; border-radius: 6px; border: 1px solid #555; background: #222; color: #fff; margin-right: 0.5rem; }
  </style>
</head>
<body>
  <h2>–ú–∏–≥—Ä–∞—Ü–∏—è —Ñ–æ—Ç–æ –≤ ImgBB + Firestore</h2>
  <p class="info">–í–æ–π–¥–∏—Ç–µ, –∑–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é.<br>
  –£–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ (–ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞) –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã.</p>

  <div id="authBlock">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button id="loginBtn" onclick="doLogin()">–í–æ–π—Ç–∏</button>
    <span id="authStatus" style="color:#aaa;"></span>
  </div>

  <button id="startBtn" onclick="startMigration(false)" disabled>‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é</button>
  <button id="forceBtn" onclick="startMigration(true)" disabled style="background:#ff6a6a;">üóë –û—á–∏—Å—Ç–∏—Ç—å Firestore –∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
  <button id="syncBtn" onclick="syncFirestore()" disabled style="background:#4a9eff;">üîÑ –£–¥–∞–ª–∏—Ç—å –±–∏—Ç—ã–µ —Å—Å—ã–ª–∫–∏ –∏–∑ Firestore</button>

  <div id="log"></div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    const SUPABASE_URL = 'https://mjbvsmvghqubdwkfgyvg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qYnZzbXZnaHF1YmR3a2ZneXZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5Mzk5NTUsImV4cCI6MjA4NzUxNTk1NX0.s0WMpvN7M6ieg5l1tg3mVkcIXjUKr_cNFkrX1IlRy_k';
    const SUPABASE_BUCKET = 'photos';

    firebase.initializeApp({
      apiKey: "AIzaSyDagIJQMr_I6i6T_ZdkGwk09lIOZmgoKcQ",
      authDomain: "riverhedgehogs.firebaseapp.com",
      projectId: "riverhedgehogs",
      storageBucket: "riverhedgehogs.firebasestorage.app",
      messagingSenderId: "101156697117",
      appId: "1:101156697117:web:755e1e1457a5d0ed9942f4"
    });

    const auth = firebase.auth();
    const db = firebase.firestore();

    function log(msg, cls = '') {
      const div = document.getElementById('log');
      const ts = new Date().toLocaleTimeString('ru', { hour12: false });
      div.innerHTML += `<span style="color:#555">[${ts}]</span> <span class="${cls}">${msg}</span>\n`;
      div.scrollTop = div.scrollHeight;
      console.log(`[${ts}] ${msg}`);
    }

    window.addEventListener('unhandledrejection', e => {
      log('–ù–ï–û–ë–†–ê–ë–û–¢–ê–ù–ù–ê–Ø –û–®–ò–ë–ö–ê: ' + (e.reason?.message || e.reason), 'err');
    });

    async function doLogin() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      log(`–í—Ö–æ–¥: ${email}`, 'info');
      try {
        const cred = await auth.signInWithEmailAndPassword(email, password);
        log(`‚úì –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${cred.user.email}`, 'ok');
        document.getElementById('authStatus').textContent = '‚úì –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
        document.getElementById('authStatus').style.color = '#38ef7d';
        document.getElementById('startBtn').disabled = false;
        document.getElementById('forceBtn').disabled = false;
        document.getElementById('syncBtn').disabled = false;
        document.getElementById('loginBtn').disabled = true;
      } catch (e) {
        log(`‚úó –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ [${e.code}]: ${e.message}`, 'err');
        document.getElementById('authStatus').textContent = '–û—à–∏–±–∫–∞: ' + e.message;
        document.getElementById('authStatus').style.color = '#ff6a6a';
      }
    }

    async function startMigration(force = false) {
      document.getElementById('startBtn').disabled = true;
      document.getElementById('forceBtn').disabled = true;
      document.getElementById('log').innerHTML = '';

      // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–æ—Ç–æ
      log('–®–∞–≥ 1: –∑–∞–≥—Ä—É–∂–∞–µ–º photos.json...', 'info');
      let photos;
      try {
        const res = await fetch('assets/photo-presentation/photos.json');
        log(`  HTTP —Å—Ç–∞—Ç—É—Å: ${res.status}`, res.ok ? 'info' : 'err');
        photos = await res.json();
        log(`  –ù–∞–π–¥–µ–Ω–æ ${photos.length} —Ñ–æ—Ç–æ`, 'info');
      } catch (e) {
        log(`‚úó –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å photos.json: ${e.message}`, 'err');
        document.getElementById('startBtn').disabled = false;
        document.getElementById('forceBtn').disabled = false;
        return;
      }

      // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º / –æ—á–∏—â–∞–µ–º Firestore
      log('\n–®–∞–≥ 2: –ø—Ä–æ–≤–µ—Ä—è–µ–º Firestore...', 'info');
      const existing = new Set();
      try {
        const snap = await db.collection('photos').get();
        log(`  –î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ photos: ${snap.size}`, 'info');

        if (force && snap.size > 0) {
          log(`  –£–¥–∞–ª—è–µ–º ${snap.size} —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π...`, 'info');
          const batch = db.batch();
          snap.docs.forEach(doc => batch.delete(doc.ref));
          await batch.commit();
          log(`  ‚úì Firestore –æ—á–∏—â–µ–Ω`, 'ok');
        } else {
          snap.forEach(doc => {
            const name = doc.data().originalName;
            if (name) existing.add(name);
          });
          log(`  –£–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${existing.size} —Ñ–æ—Ç–æ`, 'info');
        }
      } catch (e) {
        log(`‚úó –û—à–∏–±–∫–∞ Firestore [${e.code}]: ${e.message}`, 'err');
        document.getElementById('startBtn').disabled = false;
        document.getElementById('forceBtn').disabled = false;
        return;
      }

      // 3. –ú–∏–≥—Ä–∏—Ä—É–µ–º
      log('\n–®–∞–≥ 3: –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ ImgBB...', 'info');
      let uploaded = 0, skipped = 0, failed = 0;

      for (const filename of photos) {
        if (existing.has(filename)) {
          log(`  ‚è≠  –ø—Ä–æ–ø—É—â–µ–Ω: ${filename}`, 'info');
          skipped++;
          continue;
        }
        try {
          // –§–µ—Ç—á–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
          const fetchRes = await fetch(`assets/photo-presentation/${filename}`);
          if (!fetchRes.ok) throw new Error(`HTTP ${fetchRes.status} –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞`);
          const blob = await fetchRes.blob();
          log(`  ‚Üë  ${filename} (${(blob.size / 1024).toFixed(0)} KB) ‚Üí ImgBB...`, 'info');

          // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ Supabase Storage
          const storageName = `${Date.now()}_${filename}`;
          const uploadRes = await fetch(`${SUPABASE_URL}/storage/v1/object/${SUPABASE_BUCKET}/${encodeURIComponent(storageName)}`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': blob.type || 'image/jpeg',
            },
            body: blob
          });
          if (!uploadRes.ok) {
            const errJson = await uploadRes.json().catch(() => ({}));
            throw new Error(errJson.message || `Supabase upload failed: ${uploadRes.status}`);
          }
          const url = `${SUPABASE_URL}/storage/v1/object/public/${SUPABASE_BUCKET}/${encodeURIComponent(storageName)}`;

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore
          await db.collection('photos').add({
            url,
            uploadedBy: auth.currentUser.email,
            originalName: filename,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          log(`  ‚úì  ${filename} ‚Üí ${url}`, 'ok');
          uploaded++;

          // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–ø–∞–º–∏—Ç—å API
          await new Promise(r => setTimeout(r, 300));
        } catch (e) {
          log(`  ‚úó  –æ—à–∏–±–∫–∞ (${filename}): ${e.message}`, 'err');
          console.error(e);
          failed++;
        }
      }

      log(`\n=== –ò—Ç–æ–≥: –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${uploaded}, –ø—Ä–æ–ø—É—â–µ–Ω–æ ${skipped}, –æ—à–∏–±–æ–∫ ${failed} ===`,
        failed === 0 ? 'ok' : 'err');
      document.getElementById('startBtn').disabled = false;
      document.getElementById('forceBtn').disabled = false;
    }
    async function syncFirestore() {
      document.getElementById('syncBtn').disabled = true;
      document.getElementById('log').innerHTML = '';
      log('–ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ URL –∏–∑ Firestore...', 'info');

      let snap;
      try {
        snap = await db.collection('photos').get();
        log(`  –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${snap.size}`, 'info');
      } catch (e) {
        log(`‚úó –û—à–∏–±–∫–∞ Firestore: ${e.message}`, 'err');
        document.getElementById('syncBtn').disabled = false;
        return;
      }

      let removed = 0, alive = 0;
      for (const doc of snap.docs) {
        const url = doc.data().url;
        try {
          const res = await fetch(url, { method: 'HEAD' });
          if (res.ok) {
            log(`  ‚úì OK: ${doc.data().originalName || url.split('/').pop()}`, 'ok');
            alive++;
          } else {
            log(`  ‚úó ${res.status} ‚Äî —É–¥–∞–ª—è—é –∑–∞–ø–∏—Å—å: ${doc.data().originalName || url.split('/').pop()}`, 'err');
            await doc.ref.delete();
            removed++;
          }
        } catch (e) {
          log(`  ‚úó –°–µ—Ç—å/–æ—à–∏–±–∫–∞ ‚Äî —É–¥–∞–ª—è—é –∑–∞–ø–∏—Å—å: ${doc.data().originalName || url.split('/').pop()}`, 'err');
          await doc.ref.delete();
          removed++;
        }
      }

      log(`\n=== –ì–æ—Ç–æ–≤–æ: –∞–∫—Ç–∏–≤–Ω—ã—Ö ${alive}, —É–¥–∞–ª–µ–Ω–æ –∏–∑ Firestore ${removed} ===`, removed > 0 ? 'ok' : 'info');
      document.getElementById('syncBtn').disabled = false;
    }
  </script>
</body>
</html>
